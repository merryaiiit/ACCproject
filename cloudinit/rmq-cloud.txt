#cloud-config

apt_update: true
apt_upgrade: false
byobu_default: system

runcmd:
 - modprobe {nfs,nfsd,rpcsec_gss_krb5}
 - HOST=$(hostname)
 - sed "/127.0.0.1/s/$/ $HOST/" /etc/hosts | sudo tee /etc/hosts
 - sudo apt -y install docker-compose
 - sudo apt -y install git
 - sudo apt -y install python3-pip
 - cd /home/ubuntu/
 - pwd
 - git init
 - git clone https://github.com/merryaiiit/ACCproject.git && sleep 10
 - pwd
 - cd ./ACCproject/docker
 - sudo docker-compose -f rmq.yml up -d && cd ../cloudinit
 - RMQIP=$(ifconfig -a | grep "192.*.*.*n" -o | rev | cut -c 2- | rev)
 - echo "Local IP is"
 - sed 's,to_be_replaced,'"${RMQIP}"',g' ./entry-cloud.txt | sudo tee ./entry-cloud.txt
 - pip3 install python-novaclient python-keystoneclient && python3 create_entry.py
